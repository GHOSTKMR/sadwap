<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reconciliation Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .month-selector {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .month-selector select, .month-selector input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input {
            padding: 4px;
            border: 1px solid #ddd;
            max-width: 120px;
        }
        .red { color: red; }
        .blue { color: blue; }
        .green { color: green; }
        .highlight { background-color: #fff3cd; }
        button {
            padding: 6px 12px;
            margin: 2px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .delete-btn { background-color: #f44336; }
        #addRow { margin-bottom: 10px; }
        .save-btn { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="month-selector">
        <select id="monthSelect">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
        <input type="number" id="yearInput" min="2000" max="2100" value="2024">
    </div>

    <button id="addRow">Add New Row</button>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>POS Span</th>
                <th>Reconciliation</th>
                <th>POS Cash</th>
                <th>Collected Cash</th>
                <th>Cash VR</th>
                <th>Span/Recon VR</th>
                <th>Net Short</th>
                <th>Cashier's Name</th>
                <th>File Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="calculatorBody">
            <!-- Rows will be added dynamically -->
        </tbody>
    </table>
    <button class="save-btn" onclick="saveData()">Save All Data</button>
    <button class="save-btn" onclick="exportToExcel()">Export to Excel</button>

    <script>
        function getStorageKey() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearInput').value;
            return `reconciliationData_${year}_${month}`;
        }

        function createRow(data = {}) {
            const row = document.createElement('tr');
            
            // Date input
            const dateCell = document.createElement('td');
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'date-input';
            dateInput.value = data.date || '';
            dateCell.appendChild(dateInput);
            row.appendChild(dateCell);

            // POS Span
            const posSpanCell = document.createElement('td');
            const posSpanInput = document.createElement('input');
            posSpanInput.type = 'number';
            posSpanInput.className = 'pos-span';
            posSpanInput.value = data.posSpan || '';
            posSpanCell.appendChild(posSpanInput);
            row.appendChild(posSpanCell);

            // Reconciliation
            const reconCell = document.createElement('td');
            const reconInput = document.createElement('input');
            reconInput.type = 'number';
            reconInput.className = 'reconciliation';
            reconInput.value = data.reconciliation || '';
            reconCell.appendChild(reconInput);
            row.appendChild(reconCell);

            // POS Cash
            const posCashCell = document.createElement('td');
            const posCashInput = document.createElement('input');
            posCashInput.type = 'number';
            posCashInput.className = 'pos-cash';
            posCashInput.value = data.posCash || '';
            posCashCell.appendChild(posCashInput);
            row.appendChild(posCashCell);

            // Collected Cash
            const collectedCashCell = document.createElement('td');
            const collectedCashInput = document.createElement('input');
            collectedCashInput.type = 'number';
            collectedCashInput.className = 'collected-cash';
            collectedCashInput.value = data.collectedCash || '';
            collectedCashCell.appendChild(collectedCashInput);
            row.appendChild(collectedCashCell);

            // Calculated cells
            const cashVrCell = document.createElement('td');
            cashVrCell.className = 'cash-vr';
            row.appendChild(cashVrCell);

            const spanReconVrCell = document.createElement('td');
            spanReconVrCell.className = 'span-recon-vr';
            row.appendChild(spanReconVrCell);

            const netShortCell = document.createElement('td');
            netShortCell.className = 'net-short';
            row.appendChild(netShortCell);

            // Cashier's Name
            const cashierCell = document.createElement('td');
            const cashierInput = document.createElement('input');
            cashierInput.type = 'text';
            cashierInput.className = 'cashier-name';
            cashierInput.value = data.cashierName || '';
            cashierCell.appendChild(cashierInput);
            row.appendChild(cashierCell);

            // File Number
            const fileNumberCell = document.createElement('td');
            const fileNumberInput = document.createElement('input');
            fileNumberInput.type = 'text';
            fileNumberInput.className = 'file-number';
            fileNumberInput.value = data.fileNumber || '';
            fileNumberCell.appendChild(fileNumberInput);
            row.appendChild(fileNumberCell);

            // Delete button
            const actionsCell = document.createElement('td');
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => row.remove();
            actionsCell.appendChild(deleteBtn);
            row.appendChild(actionsCell);

            // Add input listeners
            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => calculateRowValues(row));
            });

            calculateRowValues(row);
            return row;
        }

        function calculateRowValues(row) {
            const posSpan = parseFloat(row.querySelector('.pos-span').value) || 0;
            const reconciliation = parseFloat(row.querySelector('.reconciliation').value) || 0;
            const posCash = parseFloat(row.querySelector('.pos-cash').value) || 0;
            const collectedCash = parseFloat(row.querySelector('.collected-cash').value) || 0;

            // Calculate values
            const cashVR = posCash - collectedCash;
            const spanReconVR = reconciliation - posSpan;
            const netShort = spanReconVR - cashVR;

            // Update cells
            row.querySelector('.cash-vr').textContent = cashVR.toFixed(2);
            row.querySelector('.cash-vr').className = `cash-vr ${cashVR < 0 ? 'red' : 'blue'}`;
            
            row.querySelector('.span-recon-vr').textContent = spanReconVR.toFixed(2);
            
            const netShortCell = row.querySelector('.net-short');
            netShortCell.textContent = netShort.toFixed(2);
            netShortCell.className = `net-short ${netShort === 0 ? 'green' : 'red'}`;

            // Highlight discrepancy fields
            const cashierInput = row.querySelector('.cashier-name');
            const fileInput = row.querySelector('.file-number');
            if (netShort !== 0) {
                cashierInput.classList.add('highlight');
                fileInput.classList.add('highlight');
            } else {
                cashierInput.classList.remove('highlight');
                fileInput.classList.remove('highlight');
            }
        }

        document.getElementById('addRow').addEventListener('click', () => {
            document.getElementById('calculatorBody').appendChild(createRow());
        });

        function saveData() {
            const rows = Array.from(document.querySelectorAll('#calculatorBody tr'));
            const data = rows.map(row => ({
                date: row.querySelector('.date-input').value,
                posSpan: row.querySelector('.pos-span').value,
                reconciliation: row.querySelector('.reconciliation').value,
                posCash: row.querySelector('.pos-cash').value,
                collectedCash: row.querySelector('.collected-cash').value,
                cashierName: row.querySelector('.cashier-name').value,
                fileNumber: row.querySelector('.file-number').value,
                cashVR: row.querySelector('.cash-vr').textContent,
                spanReconVR: row.querySelector('.span-recon-vr').textContent,
                netShort: row.querySelector('.net-short').textContent
            }));

            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            alert(`Data saved for ${getSelectedMonthYear()}!`);
        }

        function loadMonthData() {
            const savedData = localStorage.getItem(getStorageKey());
            const calculatorBody = document.getElementById('calculatorBody');
            calculatorBody.innerHTML = '';

            if (savedData) {
                JSON.parse(savedData).forEach(data => {
                    calculatorBody.appendChild(createRow(data));
                });
            } else {
                calculatorBody.appendChild(createRow());
            }
        }

        function getSelectedMonthYear() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                              "July", "August", "September", "October", "November", "December"];
            const month = monthNames[document.getElementById('monthSelect').value];
            const year = document.getElementById('yearInput').value;
            return `${month} ${year}`;
        }

        function exportToExcel() {
            const monthYear = getSelectedMonthYear().replace(' ', '_');
            const rows = document.querySelectorAll('#calculatorBody tr');
            const csvContent = [];
            const headers = ["Date", "POS Span", "Reconciliation", "POS Cash", "Collected Cash", 
                           "Cash VR", "Span/Recon VR", "Net Short", "Cashier's Name", "File Number"];
            
            csvContent.push(headers.join(','));
            
            rows.forEach(row => {
                const cells = [
                    row.querySelector('.date-input').value,
                    row.querySelector('.pos-span').value,
                    row.querySelector('.reconciliation').value,
                    row.querySelector('.pos-cash').value,
                    row.querySelector('.collected-cash').value,
                    row.querySelector('.cash-vr').textContent,
                    row.querySelector('.span-recon-vr').textContent,
                    row.querySelector('.net-short').textContent,
                    row.querySelector('.cashier-name').value,
                    row.querySelector('.file-number').value
                ];
                csvContent.push(cells.map(c => `"${c.replace(/"/g, '""')}"`).join(','));
            });

            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reconciliation_${monthYear}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event listeners for month/year change
        document.getElementById('monthSelect').addEventListener('change', loadMonthData);
        document.getElementById('yearInput').addEventListener('change', loadMonthData);

        // Initialize with current month/year
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth();
            document.getElementById('yearInput').value = now.getFullYear();
            loadMonthData();
        });
    </script>
</body>
</html>
