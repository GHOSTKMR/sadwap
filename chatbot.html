<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Cleaning Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bs-primary: #0d6efd;
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-danger: #dc3545;
            --bs-warning: #ffc107;
            --bs-info: #0dcaf0;
            --bs-light: #f8f9fa;
            --bs-dark: #212529;
            --bs-restaurant: #e63946;
            --bs-restaurant-light: #f8d7da;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: #121212;
            --bs-body-color: #ffffff;
            --bs-secondary-bg: #2d2d2d;
            --bs-tertiary-bg: #3d3d3d;
            --bs-card-bg: #1e1e1e;
            --bs-restaurant: #ff6b6b;
            --bs-restaurant-light: #3d2d2d;
        }

        body {
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            padding-bottom: 80px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .app-header {
            background: linear-gradient(135deg, var(--bs-restaurant), #c1121f);
            color: white;
            padding: 1rem 0;
            border-radius: 0 0 1rem 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .store-info {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .card {
            background-color: var(--bs-card-bg, white);
            border: 1px solid var(--bs-secondary-bg);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            border-bottom: 1px solid var(--bs-secondary-bg);
            border-radius: 0.75rem 0.75rem 0 0 !important;
            padding: 1rem 1.25rem;
        }

        .task-card {
            margin-bottom: 1rem;
            border-left: 4px solid var(--bs-primary);
        }

        .task-card.high-priority {
            border-left-color: var(--bs-danger);
        }

        .task-card.medium-priority {
            border-left-color: var(--bs-warning);
        }

        .task-card.low-priority {
            border-left-color: var(--bs-success);
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 250px;
            background-color: var(--bs-secondary-bg);
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        #videoElement, #capturedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 0 10px;
        }

        .camera-controls .btn {
            flex: 1;
            max-width: 120px;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .pdf-export {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .task-image {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            border-radius: 0.375rem;
        }

        .status-badge {
            font-size: 0.75rem;
        }

        .crew-member {
            display: inline-flex;
            align-items: center;
            background-color: var(--bs-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            margin: 0.25rem;
            font-size: 0.875rem;
        }

        .crew-member .remove-crew {
            margin-left: 0.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
        }

        .crew-input-container {
            position: relative;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-secondary-bg);
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--bs-secondary-bg);
        }

        .suggestion-item:hover {
            background-color: var(--bs-secondary-bg);
        }

        .stats-card {
            text-align: center;
            padding: 1rem;
        }

        .stats-number {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--bs-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--bs-primary), #0056b3);
            border: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--bs-success), #0a5c36);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--bs-danger), #a71e2a);
            border: none;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--bs-warning), #d39e00);
            border: none;
        }

        .btn-restaurant {
            background: linear-gradient(135deg, var(--bs-restaurant), #c1121f);
            border: none;
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .priority-high {
            color: var(--bs-danger);
        }

        .priority-medium {
            color: var(--bs-warning);
        }

        .priority-low {
            color: var(--bs-success);
        }

        .form-control, .form-select {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border: 1px solid var(--bs-secondary-bg);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .team-management {
            margin-bottom: 1rem;
        }

        .team-member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .team-member {
            display: flex;
            align-items: center;
            background-color: var(--bs-info);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }

        .team-member .remove-team-member {
            margin-left: 0.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
        }

        .data-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            font-size: 0.8rem;
            background-color: var(--bs-success);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: none;
        }

        .app-title {
            font-weight: bold;
            text-align: center;
        }

        .store-name {
            font-weight: bold;
            font-size: 1.25rem;
        }

        .store-location {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .camera-controls .btn {
                max-width: 100%;
                width: 100%;
                margin-bottom: 5px;
            }
            
            .stats-card {
                padding: 0.75rem;
            }
            
            .stats-number {
                font-size: 1.5rem;
            }
            
            .team-member-list, #selectedCrew {
                justify-content: center;
            }
        }

        /* PDF-specific styles */
        .pdf-content {
            background-color: white;
            color: black;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .pdf-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e63946;
            padding-bottom: 15px;
        }

        .pdf-logo {
            font-size: 24px;
            color: #e63946;
            margin-bottom: 10px;
        }

        .pdf-task-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }

        .pdf-task-image {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .pdf-priority-high {
            color: #dc3545;
            font-weight: bold;
        }

        .pdf-priority-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .pdf-priority-low {
            color: #198754;
            font-weight: bold;
        }

        .pdf-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body data-bs-theme="light">
    <!-- App Header with Logo and Store Info -->
    <div class="app-header">
        <div class="container">
            <div class="logo-container">
                <i class="bi bi-brush logo-icon"></i>
                <h1 class="app-title">Restaurant Cleaning</h1>
            </div>
            
            <div class="store-info">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label for="storeName" class="form-label">Store Name</label>
                        <input type="text" class="form-control" id="storeName" placeholder="Enter store name" value="Fine Dining Restaurant">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label for="storeLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="storeLocation" placeholder="Enter store location" value="123 Main Street, City">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Team Management -->
        <div class="card team-management">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0"><i class="bi bi-people"></i> Team Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="teamMemberInput" class="form-label fw-bold">Add Team Member</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="teamMemberInput" placeholder="Enter team member name">
                        <button class="btn btn-primary" type="button" id="addTeamMember">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                </div>
                <div>
                    <label class="form-label fw-bold">Team Members</label>
                    <div class="team-member-list" id="teamMemberList">
                        <!-- Team members will be added here dynamically -->
                        <div class="text-muted small" id="noTeamMembers">No team members added yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-4">
                <div class="card stats-card">
                    <div class="stats-number text-primary" id="totalTasks">0</div>
                    <div>Total Tasks</div>
                </div>
            </div>
            <div class="col-4">
                <div class="card stats-card">
                    <div class="stats-number text-warning" id="pendingTasks">0</div>
                    <div>Pending</div>
                </div>
            </div>
            <div class="col-4">
                <div class="card stats-card">
                    <div class="stats-number text-success" id="completedTasks">0</div>
                    <div>Completed</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <!-- Task Form -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-plus-circle"></i> Add New Cleaning Task</h5>
                    </div>
                    <div class="card-body">
                        <form id="taskForm">
                            <!-- Camera Section -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Take Picture</label>
                                <div class="camera-container">
                                    <video id="videoElement" autoplay playsinline style="display: none;"></video>
                                    <canvas id="canvasElement" style="display: none;"></canvas>
                                    <img id="capturedImage" src="" alt="Captured Image" style="display: none;">
                                    <div id="cameraPlaceholder" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                                        <i class="bi bi-camera fs-1"></i>
                                        <p class="mt-2">No image captured</p>
                                    </div>
                                </div>
                                <div class="camera-controls">
                                    <button type="button" id="startCamera" class="btn btn-primary btn-sm">
                                        <i class="bi bi-camera-video"></i> Start Camera
                                    </button>
                                    <button type="button" id="captureButton" class="btn btn-success btn-sm" disabled>
                                        <i class="bi bi-camera"></i> Capture
                                    </button>
                                    <button type="button" id="retakeButton" class="btn btn-warning btn-sm" disabled>
                                        <i class="bi bi-arrow-clockwise"></i> Retake
                                    </button>
                                </div>
                            </div>

                            <!-- Task Details -->
                            <div class="mb-3">
                                <label for="taskDescription" class="form-label fw-bold">Task Description</label>
                                <textarea class="form-control" id="taskDescription" rows="3" placeholder="Describe the cleaning task..." required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="crewInput" class="form-label fw-bold">Assign to Team Members</label>
                                <div class="crew-input-container">
                                    <input type="text" class="form-control" id="crewInput" placeholder="Type crew member name">
                                    <div class="suggestions" id="crewSuggestions"></div>
                                </div>
                                <div class="mt-2" id="selectedCrew"></div>
                                <small class="text-muted">Type a name and press Enter to add crew members</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="priority" class="form-label fw-bold">Priority</label>
                                    <select class="form-select" id="priority" required>
                                        <option value="" selected disabled>Select priority</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="area" class="form-label fw-bold">Area</label>
                                    <select class="form-select" id="area" required>
                                        <option value="" selected disabled>Select area</option>
                                        <option value="Kitchen">Kitchen</option>
                                        <option value="Dining Area">Dining Area</option>
                                        <option value="Restrooms">Restrooms</option>
                                        <option value="Storage">Storage</option>
                                        <option value="Entrance">Entrance</option>
                                        <option value="Parking">Parking</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dueDate" class="form-label fw-bold">Due Date</label>
                                    <input type="date" class="form-control" id="dueDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="finishDate" class="form-label fw-bold">Finish Date</label>
                                    <input type="date" class="form-control" id="finishDate">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="status" class="form-label fw-bold">Status</label>
                                <select class="form-select" id="status" required>
                                    <option value="Pending" selected>Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-restaurant w-100 py-2 fw-bold">
                                <i class="bi bi-plus-circle"></i> Add Task
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <!-- Task List -->
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="bi bi-list-check"></i> Task List</h5>
                        <span class="badge bg-light text-dark" id="taskCount">0 tasks</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="taskList" class="p-3">
                            <!-- Tasks will be added here dynamically -->
                            <div class="empty-state" id="emptyTaskMessage">
                                <i class="bi bi-clipboard-x"></i>
                                <h5>No tasks yet</h5>
                                <p class="text-muted">Add your first cleaning task to get started</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <button class="btn btn-danger pdf-export" id="exportPdf" title="Export as PDF">
        <i class="bi bi-file-pdf"></i>
    </button>

    <button class="btn btn-primary theme-toggle" id="themeToggleBtn" title="Toggle Theme">
        <i class="bi bi-moon"></i>
    </button>

    <div class="data-status" id="dataStatus">Data saved successfully!</div>

    <script>
        // DOM Elements
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const taskCount = document.getElementById('taskCount');
        const emptyTaskMessage = document.getElementById('emptyTaskMessage');
        const exportPdf = document.getElementById('exportPdf');
        const crewInput = document.getElementById('crewInput');
        const crewSuggestions = document.getElementById('crewSuggestions');
        const selectedCrew = document.getElementById('selectedCrew');
        const teamMemberInput = document.getElementById('teamMemberInput');
        const addTeamMemberBtn = document.getElementById('addTeamMember');
        const teamMemberList = document.getElementById('teamMemberList');
        const noTeamMembers = document.getElementById('noTeamMembers');
        const dataStatus = document.getElementById('dataStatus');
        const storeNameInput = document.getElementById('storeName');
        const storeLocationInput = document.getElementById('storeLocation');
        
        // Stats elements
        const totalTasks = document.getElementById('totalTasks');
        const pendingTasks = document.getElementById('pendingTasks');
        const completedTasks = document.getElementById('completedTasks');
        
        // Camera Elements
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('canvasElement');
        const capturedImage = document.getElementById('capturedImage');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const startCameraBtn = document.getElementById('startCamera');
        const captureButton = document.getElementById('captureButton');
        const retakeButton = document.getElementById('retakeButton');
        
        // Variables
        let stream = null;
        let tasks = [];
        let currentImageData = null;
        let assignedCrew = [];
        let teamMembers = [];
        let storeName = "Fine Dining Restaurant";
        let storeLocation = "123 Main Street, City";

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateTaskList();
            updateTaskCount();
            updateStats();
            renderTeamMembers();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').min = today;
            document.getElementById('finishDate').min = today;
            
            // Load store info
            const savedStoreName = localStorage.getItem('restaurantStoreName');
            const savedStoreLocation = localStorage.getItem('restaurantStoreLocation');
            
            if (savedStoreName) {
                storeNameInput.value = savedStoreName;
                storeName = savedStoreName;
            }
            
            if (savedStoreLocation) {
                storeLocationInput.value = savedStoreLocation;
                storeLocation = savedStoreLocation;
            }
            
            // Add event listeners for store info
            storeNameInput.addEventListener('change', saveStoreInfo);
            storeLocationInput.addEventListener('change', saveStoreInfo);
        });

        // Store Info Functions
        function saveStoreInfo() {
            storeName = storeNameInput.value;
            storeLocation = storeLocationInput.value;
            
            localStorage.setItem('restaurantStoreName', storeName);
            localStorage.setItem('restaurantStoreLocation', storeLocation);
            
            showDataStatus('Store information saved!', 'success');
        }

        // Data Management Functions
        function loadData() {
            // Load team members from localStorage
            const savedTeamMembers = localStorage.getItem('restaurantTeamMembers');
            if (savedTeamMembers) {
                teamMembers = JSON.parse(savedTeamMembers);
            } else {
                teamMembers = ['John Smith', 'Maria Garcia', 'David Johnson'];
                saveTeamMembers();
            }
            
            // Load tasks from localStorage
            const savedTasks = localStorage.getItem('restaurantCleaningTasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            } else {
                // Add sample tasks for demo
                tasks = [
                    {
                        id: 1,
                        description: "Clean kitchen floors and sanitize surfaces",
                        assignedTo: ["John Smith", "Maria Garcia"],
                        priority: "High",
                        area: "Kitchen",
                        dueDate: new Date().toISOString().split('T')[0],
                        finishDate: "",
                        status: "Pending",
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        description: "Restock restroom supplies and clean mirrors",
                        assignedTo: ["David Johnson"],
                        priority: "Medium",
                        area: "Restrooms",
                        dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                        finishDate: "",
                        status: "In Progress",
                        image: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                saveTasks();
            }
            
            showDataStatus('Data loaded successfully!', 'success');
        }

        function saveTeamMembers() {
            localStorage.setItem('restaurantTeamMembers', JSON.stringify(teamMembers));
            showDataStatus('Team members saved!', 'success');
        }

        function saveTasks() {
            localStorage.setItem('restaurantCleaningTasks', JSON.stringify(tasks));
            showDataStatus('Tasks saved!', 'success');
        }

        function showDataStatus(message, type) {
            dataStatus.textContent = message;
            dataStatus.style.backgroundColor = type === 'success' ? 'var(--bs-success)' : 'var(--bs-danger)';
            dataStatus.style.display = 'block';
            
            setTimeout(() => {
                dataStatus.style.display = 'none';
            }, 2000);
        }

        // Theme Toggle
        themeToggleBtn.addEventListener('click', function() {
            const currentTheme = document.body.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-bs-theme', newTheme);
            
            // Update icon
            const icon = themeToggleBtn.querySelector('i');
            icon.className = newTheme === 'light' ? 'bi bi-moon' : 'bi bi-sun';
            
            localStorage.setItem('restaurantTheme', newTheme);
        });

        // Load saved theme
        const savedTheme = localStorage.getItem('restaurantTheme') || 'light';
        document.body.setAttribute('data-bs-theme', savedTheme);
        const icon = themeToggleBtn.querySelector('i');
        icon.className = savedTheme === 'light' ? 'bi bi-moon' : 'bi bi-sun';

        // Team Management
        addTeamMemberBtn.addEventListener('click', function() {
            addTeamMember(teamMemberInput.value.trim());
        });

        teamMemberInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTeamMember(this.value.trim());
            }
        });

        function addTeamMember(name) {
            if (name && !teamMembers.includes(name)) {
                teamMembers.push(name);
                saveTeamMembers();
                renderTeamMembers();
                teamMemberInput.value = '';
                showAlert(`Team member "${name}" added successfully!`, 'success');
            } else if (teamMembers.includes(name)) {
                showAlert(`Team member "${name}" already exists!`, 'warning');
            }
        }

        function removeTeamMember(name) {
            teamMembers = teamMembers.filter(member => member !== name);
            saveTeamMembers();
            renderTeamMembers();
            showAlert(`Team member "${name}" removed!`, 'info');
        }

        function renderTeamMembers() {
            teamMemberList.innerHTML = '';
            
            if (teamMembers.length === 0) {
                noTeamMembers.style.display = 'block';
                teamMemberList.appendChild(noTeamMembers);
                return;
            }
            
            noTeamMembers.style.display = 'none';
            
            teamMembers.forEach(member => {
                const span = document.createElement('span');
                span.className = 'team-member';
                span.innerHTML = `
                    ${member}
                    <button type="button" class="remove-team-member" onclick="removeTeamMember('${member}')">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                teamMemberList.appendChild(span);
            });
        }

        // Crew Member Assignment
        crewInput.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            if (value.length > 0) {
                const filteredCrew = teamMembers.filter(member => 
                    member.toLowerCase().includes(value) && 
                    !assignedCrew.includes(member)
                );
                
                showSuggestions(filteredCrew);
            } else {
                hideSuggestions();
            }
        });

        crewInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCrewMember(this.value.trim());
                this.value = '';
                hideSuggestions();
            }
        });

        function showSuggestions(suggestions) {
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            
            crewSuggestions.innerHTML = '';
            suggestions.forEach(member => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = member;
                div.addEventListener('click', function() {
                    addCrewMember(member);
                    crewInput.value = '';
                    hideSuggestions();
                });
                crewSuggestions.appendChild(div);
            });
            
            crewSuggestions.style.display = 'block';
        }

        function hideSuggestions() {
            crewSuggestions.style.display = 'none';
        }

        function addCrewMember(name) {
            if (name && !assignedCrew.includes(name)) {
                if (teamMembers.includes(name)) {
                    assignedCrew.push(name);
                    renderCrewMembers();
                } else {
                    showAlert(`"${name}" is not in your team. Add them to your team first.`, 'warning');
                }
            } else if (assignedCrew.includes(name)) {
                showAlert(`"${name}" is already assigned to this task.`, 'info');
            }
        }

        function removeCrewMember(name) {
            assignedCrew = assignedCrew.filter(member => member !== name);
            renderCrewMembers();
        }

        function renderCrewMembers() {
            selectedCrew.innerHTML = '';
            assignedCrew.forEach(member => {
                const span = document.createElement('span');
                span.className = 'crew-member';
                span.innerHTML = `
                    ${member}
                    <button type="button" class="remove-crew" onclick="removeCrewMember('${member}')">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                selectedCrew.appendChild(span);
            });
        }

        // Camera Functions
        startCameraBtn.addEventListener('click', async function() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                videoElement.srcObject = stream;
                videoElement.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                capturedImage.style.display = 'none';
                startCameraBtn.disabled = true;
                captureButton.disabled = false;
                retakeButton.disabled = true;
            } catch (err) {
                alert('Error accessing camera: ' + err.message);
            }
        });

        captureButton.addEventListener('click', function() {
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            // Convert to data URL
            currentImageData = canvasElement.toDataURL('image/png');
            capturedImage.src = currentImageData;
            capturedImage.style.display = 'block';
            videoElement.style.display = 'none';
            
            // Stop camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            captureButton.disabled = true;
            retakeButton.disabled = false;
            startCameraBtn.disabled = false;
        });

        retakeButton.addEventListener('click', function() {
            capturedImage.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            currentImageData = null;
            retakeButton.disabled = true;
            captureButton.disabled = true;
            startCameraBtn.disabled = false;
        });

        // Task Form Submission
        taskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskDescription = document.getElementById('taskDescription').value;
            const priority = document.getElementById('priority').value;
            const area = document.getElementById('area').value;
            const dueDate = document.getElementById('dueDate').value;
            const finishDate = document.getElementById('finishDate').value;
            const status = document.getElementById('status').value;
            
            if (assignedCrew.length === 0) {
                showAlert('Please assign at least one crew member!', 'warning');
                return;
            }
            
            const task = {
                id: Date.now(),
                description: taskDescription,
                assignedTo: [...assignedCrew],
                priority: priority,
                area: area,
                dueDate: dueDate,
                finishDate: finishDate,
                status: status,
                image: currentImageData,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(task);
            saveTasks();
            updateTaskList();
            updateTaskCount();
            updateStats();
            resetForm();
            
            // Show success message
            showAlert('Task added successfully!', 'success');
        });

        function resetForm() {
            taskForm.reset();
            capturedImage.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
            currentImageData = null;
            assignedCrew = [];
            renderCrewMembers();
            retakeButton.disabled = true;
            captureButton.disabled = true;
            startCameraBtn.disabled = false;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function updateTaskList() {
            if (tasks.length === 0) {
                emptyTaskMessage.style.display = 'block';
                taskList.innerHTML = '';
                taskList.appendChild(emptyTaskMessage);
                return;
            }
            
            emptyTaskMessage.style.display = 'none';
            
            // Sort tasks by due date (oldest first)
            tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            taskList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = `card task-card mb-3 fade-in ${task.priority.toLowerCase()}-priority`;
                
                // Priority badge color
                let priorityClass = 'bg-secondary';
                if (task.priority === 'High') priorityClass = 'bg-danger';
                if (task.priority === 'Medium') priorityClass = 'bg-warning';
                if (task.priority === 'Low') priorityClass = 'bg-success';
                
                // Status badge color
                let statusClass = 'bg-secondary';
                if (task.status === 'In Progress') statusClass = 'bg-primary';
                if (task.status === 'Completed') statusClass = 'bg-success';
                
                // Format dates
                const dueDate = new Date(task.dueDate).toLocaleDateString();
                const finishDate = task.finishDate ? new Date(task.finishDate).toLocaleDateString() : 'Not set';
                
                taskCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">${task.description}</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary border-0" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editTask(${task.id})"><i class="bi bi-pencil"></i> Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTask(${task.id})"><i class="bi bi-trash"></i> Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        ${task.image ? `<img src="${task.image}" class="task-image mb-2" alt="Task Image">` : ''}
                        
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <span class="badge ${priorityClass} status-badge">${task.priority}</span>
                            <span class="badge ${statusClass} status-badge">${task.status}</span>
                            <span class="badge bg-info status-badge">${task.area}</span>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted"><i class="bi bi-people"></i> Assigned to:</small>
                            <div class="mt-1">
                                ${task.assignedTo.map(member => 
                                    `<span class="crew-member">${member}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="row small text-muted">
                            <div class="col-6">
                                <i class="bi bi-calendar-event"></i> Due: ${dueDate}
                            </div>
                            <div class="col-6">
                                <i class="bi bi-calendar-check"></i> Finish: ${finishDate}
                            </div>
                        </div>
                    </div>
                `;
                
                taskList.appendChild(taskCard);
            });
        }

        function updateTaskCount() {
            taskCount.textContent = `${tasks.length} ${tasks.length === 1 ? 'task' : 'tasks'}`;
        }

        function updateStats() {
            totalTasks.textContent = tasks.length;
            const pending = tasks.filter(task => task.status === 'Pending').length;
            const completed = tasks.filter(task => task.status === 'Completed').length;
            
            pendingTasks.textContent = pending;
            completedTasks.textContent = completed;
        }

        function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(task => task.id !== id);
                saveTasks();
                updateTaskList();
                updateTaskCount();
                updateStats();
                showAlert('Task deleted successfully!', 'danger');
            }
        }

        function editTask(id) {
            // For simplicity, we'll just delete and let user recreate
            // In a real app, you would implement a proper edit form
            const task = tasks.find(t => t.id === id);
            if (task) {
                document.getElementById('taskDescription').value = task.description;
                document.getElementById('priority').value = task.priority;
                document.getElementById('area').value = task.area;
                document.getElementById('dueDate').value = task.dueDate;
                document.getElementById('finishDate').value = task.finishDate || '';
                document.getElementById('status').value = task.status;
                
                assignedCrew = [...task.assignedTo];
                renderCrewMembers();
                
                if (task.image) {
                    currentImageData = task.image;
                    capturedImage.src = task.image;
                    capturedImage.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                    retakeButton.disabled = false;
                }
                
                // Remove the task being edited
                tasks = tasks.filter(t => t.id !== id);
                saveTasks();
                updateTaskList();
                updateTaskCount();
                updateStats();
                
                // Scroll to form
                document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
                
                showAlert('Task loaded for editing!', 'info');
            }
        }

        function showAlert(message, type) {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alert.style.zIndex = '1050';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // Auto dismiss after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        // PDF Export - Fixed version
        exportPdf.addEventListener('click', function() {
            if (tasks.length === 0) {
                showAlert('No tasks to export!', 'warning');
                return;
            }
            
            // Create a temporary element for PDF generation
            const element = document.createElement('div');
            element.className = 'pdf-content';
            
            // Create the PDF content
            let pdfHTML = `
                <div class="pdf-header">
                    <div class="pdf-logo">
                        <i class="bi bi-brush"></i> Restaurant Cleaning Task Report
                    </div>
                    <h2>${storeName}</h2>
                    <p>${storeLocation}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                <div>
            `;
            
            // Add each task to the PDF
            tasks.forEach((task, index) => {
                // Priority styling
                let priorityClass = '';
                if (task.priority === 'High') priorityClass = 'pdf-priority-high';
                if (task.priority === 'Medium') priorityClass = 'pdf-priority-medium';
                if (task.priority === 'Low') priorityClass = 'pdf-priority-low';
                
                // Format dates
                const dueDate = new Date(task.dueDate).toLocaleDateString();
                const finishDate = task.finishDate ? new Date(task.finishDate).toLocaleDateString() : 'Not set';
                const createdDate = new Date(task.createdAt).toLocaleDateString();
                
                pdfHTML += `
                    <div class="pdf-task-card">
                        <h3>Task ${index + 1}: ${task.description}</h3>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                            <div><strong>Priority:</strong> <span class="${priorityClass}">${task.priority}</span></div>
                            <div><strong>Status:</strong> ${task.status}</div>
                            <div><strong>Area:</strong> ${task.area}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong>Assigned to:</strong> ${task.assignedTo.join(', ')}
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 10px;">
                            <div><strong>Due Date:</strong> ${dueDate}</div>
                            <div><strong>Finish Date:</strong> ${finishDate}</div>
                            <div><strong>Created:</strong> ${createdDate}</div>
                        </div>
                        
                        ${task.image ? `<img src="${task.image}" class="pdf-task-image" alt="Task Image">` : '<p><em>No image available</em></p>'}
                    </div>
                `;
            });
            
            // Add summary section
            const pendingCount = tasks.filter(t => t.status === 'Pending').length;
            const inProgressCount = tasks.filter(t => t.status === 'In Progress').length;
            const completedCount = tasks.filter(t => t.status === 'Completed').length;
            const highPriorityCount = tasks.filter(t => t.priority === 'High').length;
            const mediumPriorityCount = tasks.filter(t => t.priority === 'Medium').length;
            const lowPriorityCount = tasks.filter(t => t.priority === 'Low').length;
            
            pdfHTML += `
                </div>
                <div class="pdf-summary">
                    <h4>Summary</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                        <div>
                            <h5>Status</h5>
                            <p>Total Tasks: ${tasks.length}</p>
                            <p>Pending: ${pendingCount}</p>
                            <p>In Progress: ${inProgressCount}</p>
                            <p>Completed: ${completedCount}</p>
                        </div>
                        <div>
                            <h5>Priority</h5>
                            <p>High: ${highPriorityCount}</p>
                            <p>Medium: ${mediumPriorityCount}</p>
                            <p>Low: ${lowPriorityCount}</p>
                        </div>
                    </div>
                </div>
            `;
            
            element.innerHTML = pdfHTML;
            
            // Generate PDF
            const opt = {
                margin: 1,
                filename: `cleaning-tasks-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Show loading message
            showAlert('Generating PDF...', 'info');
            
            // Generate and save PDF
            html2pdf().set(opt).from(element).save().then(() => {
                showAlert('PDF exported successfully!', 'success');
            }).catch(err => {
                console.error('PDF generation error:', err);
                showAlert('Error generating PDF: ' + err.message, 'danger');
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
