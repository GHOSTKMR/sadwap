<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Control System v4.7</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1a3a5f;
            --secondary-blue: #2c5282;
            --accent-blue: #4299e1;
            --light-bg: #f7fafc;
            --dark-text: #2d3748;
            --light-text: #718096;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --border-color: #e2e8f0;
        }
        
        [data-theme="dark"] {
            --primary-blue: #2d3748;
            --secondary-blue: #4a5568;
            --accent-blue: #63b3ed;
            --light-bg: #1a202c;
            --dark-text: #e2e8f0;
            --light-text: #a0aec0;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #fc8181;
            --border-color: #4a5568;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }
        
        .container-fluid {
            padding: 20px;
            max-width: 1600px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 20px 0;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .panel {
            background-color: var(--light-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .panel-title {
            color: var(--accent-blue);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
            border-color: var(--accent-blue);
        }
        
        .btn {
            border-radius: 4px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .btn-primary:hover {
            background-color: #3182ce;
            border-color: #3182ce;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #2f855a;
            border-color: #2f855a;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            border-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c53030;
            border-color: #c53030;
            transform: translateY(-1px);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 600;
            padding: 12px 15px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        tr:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .variance-positive {
            color: var(--success);
            font-weight: 600;
        }
        
        .variance-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--accent-blue);
            margin-bottom: 20px;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin: 10px 0;
        }
        
        .metric-label {
            color: var(--light-text);
            font-size: 0.9rem;
        }
        
        .metric-change {
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .metric-change.positive {
            color: var(--success);
        }
        
        .metric-change.negative {
            color: var(--danger);
        }
        
        .sales-targets-panel {
            background-color: var(--primary-blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            border-left: 4px solid var(--success);
        }
        
        .sales-input-group {
            margin: 10px;
            min-width: 200px;
            flex: 1;
        }
        
        .sales-input-group label {
            display: block;
            margin-bottom: 8px;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-ok {
            background-color: #c6f6d5;
            color: #22543d;
        }
        
        .status-warning {
            background-color: #fef5e7;
            color: #744210;
        }
        
        .status-critical {
            background-color: #fed7d7;
            color: #742a2a;
        }
        
        .date-selector {
            background-color: var(--primary-blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .selected-date-display {
            background-color: var(--secondary-blue);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
            border-left: 4px solid;
        }
        
        .alert-success {
            border-left-color: var(--success);
        }
        
        .alert-warning {
            border-left-color: var(--warning);
        }
        
        .alert-danger {
            border-left-color: var(--danger);
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .welcome-content {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .notification-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .notification-salary {
            border-left-color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }
        
        .notification-weekend {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }
        
        .notification-campaign {
            border-left-color: #ed8936;
            background: rgba(237, 137, 54, 0.1);
        }
        
        .notification-special {
            border-left-color: #9f7aea;
            background: rgba(159, 122, 234, 0.1);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .date-selector > * {
                margin-bottom: 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .sales-targets-panel {
                flex-direction: column;
            }
            
            .sales-input-group {
                width: 100%;
            }
            
            .metric-card {
                text-align: center;
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <!-- Welcome Modal -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <h2 class="mb-4 text-center"><i class="fas fa-calendar-alt me-2"></i>October 2025 - Important Notifications</h2>
            
            <div class="notification-item notification-salary">
                <h4><i class="fas fa-money-bill-wave me-2"></i>Salary Days</h4>
                <p class="mb-1"><strong>Upcoming:</strong> October 25-27 (Last 3 days of month)</p>
                <p class="mb-0"><strong>Impact:</strong> Expected 25% increase in sales during these days</p>
            </div>
            
            <div class="notification-item notification-weekend">
                <h4><i class="fas fa-calendar-day me-2"></i>Weekend Special Days</h4>
                <p class="mb-1"><strong>Weekends:</strong> Fridays & Saturdays</p>
                <p class="mb-1"><strong>Special Events:</strong> Family Weekend (Oct 10-12)</p>
                <p class="mb-0"><strong>Impact:</strong> 40% higher consumption on weekends, plan 50% extra inventory</p>
            </div>
            
            <div class="notification-item notification-campaign">
                <h4><i class="fas fa-bullhorn me-2"></i>Ongoing Campaigns</h4>
                <p class="mb-1"><strong>MIX FALCON + OG Classic</strong> Running</p>
                <p class="mb-1"><strong>....</strong> ....</p>
                <p class="mb-0"><strong>Impact:</strong> 30% sales boost expected during campaign periods</p>
            </div>
            
           
            
            <div class="mt-4 text-center">
                <button class="btn btn-primary btn-lg" id="closeWelcome">
                    <i class="fas fa-check me-2"></i> Continue to Dashboard
                </button>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-boxes me-2"></i>Inventory Control System v4.7</h1>
                    <p>Real-time inventory tracking and variance analysis</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div id="clock" class="h4 mb-1"></div>
                    <div id="date-display" class="text-light opacity-75"></div>
                </div>
            </div>
        </div>
        
        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">TOTAL ITEMS</div>
                    <div class="metric-value" id="total-items">0</div>
                    <div class="metric-change positive"><i class="fas fa-arrow-up me-1"></i> 5.2% from last month</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">OVERALL VARIANCE</div>
                    <div class="metric-value" id="overall-variance">0%</div>
                    <div class="metric-change negative"><i class="fas fa-arrow-down me-1"></i> 2.1% from target</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">ITEMS TO REPLENISH</div>
                    <div class="metric-value" id="items-to-replenish">0</div>
                    <div class="metric-change positive"><i class="fas fa-arrow-down me-1"></i> 12% from last week</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">MONTH TO DATE SALES</div>
                    <div class="metric-value" id="mtd-sales-value">SAR 0</div>
                    <div class="metric-change positive"><i class="fas fa-arrow-up me-1"></i> 8.5% from target</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <h3 class="panel-title"><i class="fas fa-chart-bar me-2"></i>Variance Analytics</h3>
                    <div class="chart-container">
                        <canvas id="varianceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h3 class="panel-title"><i class="fas fa-clipboard-list me-2"></i>Inventory Management</h3>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button id="export-excel" class="btn btn-success">
                                <i class="fas fa-file-excel me-2"></i> Export to Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sales Targets Section -->
                    <div class="sales-targets-panel">
                        <div class="sales-input-group">
                            <label for="month-to-date-sales">Month to Date Sales (SAR)</label>
                            <input type="number" id="month-to-date-sales" class="form-control" placeholder="Enter amount" value="10900">
                        </div>
                        <div class="sales-input-group">
                            <label for="average-daily-sales">Average Daily Sales (SAR)</label>
                            <input type="number" id="average-daily-sales" class="form-control" placeholder="Calculated" readonly>
                        </div>
                        <div class="sales-input-group">
                            <label for="forecast-days">Forecast Days</label>
                            <select id="forecast-days" class="form-select">
                                <option value="1">1 Day</option>
                                <option value="2">2 Days</option>
                                <option value="3" selected>3 Days</option>
                                <option value="4">4 Days</option>
                                <option value="5">5 Days</option>
                                <option value="6">6 Days</option>
                                <option value="7">7 Days</option>
                                <option value="8">8 Days</option>
                                <option value="9">9 Days</option>
                                <option value="10">10 Days</option>
                            </select>
                        </div>
                        <div class="sales-input-group">
                            <label for="sales-forecast">Sales Forecast (SAR)</label>
                            <input type="number" id="sales-forecast" class="form-control" placeholder="Calculated" readonly>
                        </div>
                    </div>
                    
                    <!-- Date Selection -->
                    <div class="date-selector">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="month-select" class="form-label">Month</label>
                                <select id="month-select" class="form-select">
                                    <option value="">Select Month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10" selected>October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="day-select" class="form-label">Day</label>
                                <select id="day-select" class="form-select">
                                    <option value="">Select Day</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year-select" class="form-label">Year</label>
                                <select id="year-select" class="form-select">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button id="load-btn" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i> Load Inventory
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <button id="new-day-btn" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-plus-circle me-2"></i> New Day
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="save-btn" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i> Save Inventory
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="selected-date-display" id="selected-date-display">
                        Select date to begin
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table" id="inventory-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>System Count</th>
                                    <th>On Hand</th>
                                    <th>Variance</th>
                                    <th>MTD Consumption</th>
                                    <th>Avg Consumption</th>
                                    <th>C/1000</th>
                                    <th>To Order</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-body">
                                <!-- Items will be loaded here automatically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Static item list - all items always displayed
            const staticItems = [
                "Philly Beef", "Beef Steak", "Chicken Steak", "Lunch Chicken", "Grill Chicken", 
                "Spicy Chicken", "12 inch Tortilla", "10.5 inch Tortilla", "8 inch Tortilla", 
                "Chicken Burger", "Junior Burger", "Nuggets", "Regular Bytes", "Spicy Bytes", 
                "Veggie", "Nachoes", "Quatro", "Aldella Strips", "Hotdog", "Eggs", 
                "Pancake Powder", "Fries", "Crispy", "Hushbrown", "Vanilla Muffin", 
                "Choco Muffin", "Sansbastian Cake", "Brownese Cheese Cake", "Smokey Beef", 
                "Smokey Chicken", "Smokey Turkey", "Steak Bread", "Brown Bread", "Big Bun", 
                "Small Bun", "Kiddie Bread", "4.0 Potato Bun", "Potato Steak Bread", 
                "White Bread", "Multigrain Bread", "Water", "Coffee Beans", "Milk Powder", 
                "Hot Chocolate", "Karak", "Mushroom", "Sweet Kernel", "Pepsi Bib", 
                "Diet Pepsi Bib", "7 Up Bib", "Dew Bib", "Merinda Bib", "Pepsi Cans", 
                "Diet Pepsi Cans", "Merinda Cans", "7up Cans", "Dew Cans", "7up Diet Cans", 
                "Lipton Can Peach", "Lipto Can Red Fruit", "Tomato", "Onion", "Green Pepper", 
                "Chives", "Cherry Tomato", "Cucumber", "Lettuce", "Salad"
            ];

            // DOM elements
            const monthSelect = document.getElementById('month-select');
            const daySelect = document.getElementById('day-select');
            const yearSelect = document.getElementById('year-select');
            const loadBtn = document.getElementById('load-btn');
            const newDayBtn = document.getElementById('new-day-btn');
            const saveBtn = document.getElementById('save-btn');
            const exportBtn = document.getElementById('export-excel');
            const selectedDateDisplay = document.getElementById('selected-date-display');
            const inventoryBody = document.getElementById('inventory-body');
            const clockElement = document.getElementById('clock');
            const dateElement = document.getElementById('date-display');
            const varianceChartCanvas = document.getElementById('varianceChart');
            const mtdSalesInput = document.getElementById('month-to-date-sales');
            const avgDailySalesInput = document.getElementById('average-daily-sales');
            const forecastDaysSelect = document.getElementById('forecast-days');
            const salesForecastInput = document.getElementById('sales-forecast');
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const welcomeModal = document.getElementById('welcomeModal');
            const closeWelcome = document.getElementById('closeWelcome');
            
            // Metric elements
            const totalItemsElement = document.getElementById('total-items');
            const overallVarianceElement = document.getElementById('overall-variance');
            const itemsToReplenishElement = document.getElementById('items-to-replenish');
            const mtdSalesValueElement = document.getElementById('mtd-sales-value');
            
            // Chart variables
            let varianceChart = null;
            
            // Current selected date
            let currentDate = null;
            let currentData = [];
            let salesData = {
                mtdSales: 10900,
                avgDailySales: 0,
                forecastDays: 3,
                salesForecast: 0
            };
            
            // Initialize the app
            function init() {
                updateClock();
                setInterval(updateClock, 1000);
                
                // Set default theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                setTheme(savedTheme);
                
                // Populate years (current year -1 to +2)
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 1; i <= currentYear + 2; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                yearSelect.value = currentYear;
                
                // Set current month and day
                const currentMonth = new Date().getMonth() + 1;
                monthSelect.value = currentMonth;
                updateDaySelect(currentMonth, currentYear);
                daySelect.value = new Date().getDate();
                
                // Create all inventory items on page load
                createInventoryItems();
                
                // Check if there's a previously selected date in localStorage
                const lastDate = localStorage.getItem('lastSelectedDate');
                if (lastDate) {
                    const [year, month, day] = lastDate.split('/');
                    yearSelect.value = year;
                    monthSelect.value = month;
                    updateDaySelect(parseInt(month), parseInt(year));
                    daySelect.value = day;
                    currentDate = lastDate;
                    loadInventoryData(currentDate);
                    updateSelectedDateDisplay(month, day, year);
                } else {
                    // Load current date by default
                    currentDate = `${currentYear}/${currentMonth}/${new Date().getDate()}`;
                    localStorage.setItem('lastSelectedDate', currentDate);
                    updateSelectedDateDisplay(currentMonth, new Date().getDate(), currentYear);
                }
                
                // Load sales data if exists
                const savedSalesData = localStorage.getItem('salesData');
                if (savedSalesData) {
                    salesData = JSON.parse(savedSalesData);
                    mtdSalesInput.value = salesData.mtdSales;
                    avgDailySalesInput.value = salesData.avgDailySales;
                    forecastDaysSelect.value = salesData.forecastDays;
                    salesForecastInput.value = salesData.salesForecast;
                    
                    // Update metrics
                    updateMetrics();
                } else {
                    // Calculate initial sales metrics
                    calculateSalesMetrics();
                }
                
                // Load MTD consumption data if exists
                loadMTDConsumptionData();
                
                // Set up event listeners
                setupEventListeners();
                
                // Show welcome modal if first visit this month
                const lastWelcome = localStorage.getItem('lastWelcomeMonth');
                const currentMonthYear = `${currentMonth}/${currentYear}`;
                
                if (lastWelcome !== currentMonthYear) {
                    setTimeout(() => {
                        welcomeModal.style.display = 'flex';
                    }, 1000);
                    localStorage.setItem('lastWelcomeMonth', currentMonthYear);
                }
            }
            
            // Theme management
            function setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-sun';
                } else {
                    themeIcon.className = 'fas fa-moon';
                }
            }
            
            // Create all inventory items in the table
            function createInventoryItems() {
                inventoryBody.innerHTML = '';
                
                staticItems.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Item Name (fixed)
                    const itemNameCell = document.createElement('td');
                    itemNameCell.textContent = item;
                    row.appendChild(itemNameCell);
                    
                    // System Count
                    const systemCountCell = document.createElement('td');
                    const systemCountInput = document.createElement('input');
                    systemCountInput.type = 'number';
                    systemCountInput.className = 'form-control';
                    systemCountInput.value = '0';
                    systemCountInput.step = '0.01';
                    systemCountInput.min = '0';
                    systemCountCell.appendChild(systemCountInput);
                    row.appendChild(systemCountCell);
                    
                    // On Hand
                    const onHandCell = document.createElement('td');
                    const onHandInput = document.createElement('input');
                    onHandInput.type = 'number';
                    onHandInput.className = 'form-control';
                    onHandInput.value = '0';
                    onHandInput.step = '0.01';
                    onHandInput.min = '0';
                    onHandCell.appendChild(onHandInput);
                    row.appendChild(onHandCell);
                    
                    // Variance (calculated: On Hand - System Count)
                    const varianceCell = document.createElement('td');
                    varianceCell.textContent = '0';
                    row.appendChild(varianceCell);
                    
                    // MTD Consumption (user input, persists across dates)
                    const mtdConsumptionCell = document.createElement('td');
                    const mtdConsumptionInput = document.createElement('input');
                    mtdConsumptionInput.type = 'number';
                    mtdConsumptionInput.className = 'form-control mtd-consumption';
                    mtdConsumptionInput.value = '0';
                    mtdConsumptionInput.step = '0.01';
                    mtdConsumptionInput.min = '0';
                    mtdConsumptionCell.appendChild(mtdConsumptionInput);
                    row.appendChild(mtdConsumptionCell);
                    
                    // Average Consumption (calculated: MTD Consumption / current day of month)
                    const avgConsumptionCell = document.createElement('td');
                    avgConsumptionCell.textContent = '0';
                    row.appendChild(avgConsumptionCell);
                    
                    // Consumption per 1000 (calculated: avgConsumption / avgDailySales * 1000)
                    const consumptionPer1000Cell = document.createElement('td');
                    consumptionPer1000Cell.textContent = '0';
                    row.appendChild(consumptionPer1000Cell);
                    
                    // To Order (calculated: consumptionPer1000 * (salesForecast / 1000))
                    const toOrderCell = document.createElement('td');
                    toOrderCell.textContent = '0';
                    row.appendChild(toOrderCell);
                    
                    // Status (calculated: checks to order vs system count)
                    const statusCell = document.createElement('td');
                    statusCell.innerHTML = '<span class="status-badge status-ok">OK</span>';
                    row.appendChild(statusCell);
                    
                    // Add event listeners for calculation
                    const calculateValues = function() {
                        const systemCount = parseFloat(systemCountInput.value) || 0;
                        const onHand = parseFloat(onHandInput.value) || 0;
                        
                        // Calculate variance (On Hand - System Count)
                        const variance = onHand - systemCount;
                        varianceCell.textContent = variance.toFixed(2);
                        
                        // Update variance color based on the value
                        if (variance < 0) {
                            varianceCell.className = 'variance-negative';
                        } else if (variance > 0) {
                            varianceCell.className = 'variance-positive';
                        } else {
                            varianceCell.className = '';
                        }
                        
                        // Get current date for calculations
                        const today = new Date();
                        const currentDay = today.getDate();
                        
                        // Get MTD consumption
                        const mtdConsumption = parseFloat(mtdConsumptionInput.value) || 0;
                        
                        // Calculate average consumption (MTD / current day of month)
                        const avgConsumption = mtdConsumption / currentDay;
                        avgConsumptionCell.textContent = avgConsumption.toFixed(2);
                        
                        // Calculate consumption per 1000 (avgConsumption / avgDailySales * 1000)
                        const avgDailySales = parseFloat(avgDailySalesInput.value) || 1; // avoid division by zero
                        const consumptionPer1000 = (avgConsumption / avgDailySales) * 1000;
                        consumptionPer1000Cell.textContent = consumptionPer1000.toFixed(2);
                        
                        // Calculate to order (consumptionPer1000 * (salesForecast / 1000))
                        const salesForecast = parseFloat(salesForecastInput.value) || 0;
                        const toOrder = consumptionPer1000 * (salesForecast / 1000);
                        toOrderCell.textContent = toOrder.toFixed(2);
                        
                        // Calculate status (check to order vs system count)
                        const replenish = toOrder - systemCount;
                        if (replenish <= 0) {
                            statusCell.innerHTML = '<span class="status-badge status-ok">OK</span>';
                        } else if (replenish <= 10) {
                            statusCell.innerHTML = '<span class="status-badge status-warning">LOW</span>';
                        } else {
                            statusCell.innerHTML = '<span class="status-badge status-critical">ORDER</span>';
                        }
                    };
                    
                    // Add event listeners to inputs that trigger calculations
                    systemCountInput.addEventListener('change', function() {
                        calculateValues();
                        updateMetrics();
                    });
                    onHandInput.addEventListener('change', function() {
                        calculateValues();
                        updateMetrics();
                    });
                    mtdConsumptionInput.addEventListener('change', function() {
                        calculateValues();
                        saveMTDConsumptionData(); // Save MTD consumption when changed
                        updateMetrics();
                    });
                    
                    // Add row to the table
                    inventoryBody.appendChild(row);
                });
                
                // Add event listeners to sales inputs that affect calculations
                mtdSalesInput.addEventListener('input', function() {
                    calculateSalesMetrics();
                    updateAllCalculations();
                    updateMetrics();
                });
                forecastDaysSelect.addEventListener('change', function() {
                    calculateSalesMetrics();
                    updateAllCalculations();
                    updateMetrics();
                });
                
                // Update metrics with initial values
                updateMetrics();
            }
            
            // Calculate sales metrics (MTD, forecast, etc.)
            function calculateSalesMetrics() {
                // Get current values
                const mtdSales = parseFloat(mtdSalesInput.value) || 0;
                const forecastDays = parseInt(forecastDaysSelect.value) || 1;
                
                // Get current date
                const today = new Date();
                const currentDay = today.getDate();
                
                // Calculate average daily sales (MTD Sales / current day of month)
                const avgDailySales = mtdSales / currentDay;
                
                // Calculate sales forecast (average daily sales * forecast days)
                const salesForecast = avgDailySales * forecastDays;
                
                // Update the UI
                avgDailySalesInput.value = avgDailySales.toFixed(2);
                salesForecastInput.value = salesForecast.toFixed(2);
                
                // Save to salesData object
                salesData = {
                    mtdSales,
                    avgDailySales,
                    forecastDays,
                    salesForecast
                };
                
                // Save to localStorage
                localStorage.setItem('salesData', JSON.stringify(salesData));
            }
            
            // Update all calculations in the table (when sales data changes)
            function updateAllCalculations() {
                const rows = inventoryBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const systemCountInput = row.querySelector('td:nth-child(2) input');
                    const onHandInput = row.querySelector('td:nth-child(3) input');
                    const mtdConsumptionInput = row.querySelector('td:nth-child(5) input');
                    
                    // Trigger calculation for each row
                    if (systemCountInput && onHandInput && mtdConsumptionInput) {
                        systemCountInput.dispatchEvent(new Event('change'));
                        onHandInput.dispatchEvent(new Event('change'));
                        mtdConsumptionInput.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Update key metrics
            function updateMetrics() {
                // Total items
                totalItemsElement.textContent = staticItems.length;
                
                // Overall variance
                let totalVariance = 0;
                let totalSystemCount = 0;
                
                const rows = inventoryBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const systemCount = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
                    const variance = parseFloat(row.querySelector('td:nth-child(4)').textContent) || 0;
                    
                    totalSystemCount += systemCount;
                    totalVariance += Math.abs(variance);
                });
                
                const variancePercentage = totalSystemCount > 0 ? (totalVariance / totalSystemCount * 100).toFixed(1) : 0;
                overallVarianceElement.textContent = `${variancePercentage}%`;
                
                // Items to replenish
                let itemsToReplenish = 0;
                rows.forEach(row => {
                    const statusBadge = row.querySelector('.status-badge');
                    if (statusBadge && statusBadge.textContent === 'ORDER') {
                        itemsToReplenish++;
                    }
                });
                itemsToReplenishElement.textContent = itemsToReplenish;
                
                // MTD Sales value
                const mtdSales = parseFloat(mtdSalesInput.value) || 0;
                mtdSalesValueElement.textContent = `SAR ${mtdSales.toLocaleString()}`;
            }
            
            // Save MTD consumption data to localStorage
            function saveMTDConsumptionData() {
                const mtdConsumptionData = {};
                const rows = inventoryBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const itemName = row.querySelector('td:first-child').textContent;
                    const mtdConsumptionInput = row.querySelector('.mtd-consumption');
                    if (mtdConsumptionInput) {
                        mtdConsumptionData[itemName] = parseFloat(mtdConsumptionInput.value) || 0;
                    }
                });
                
                localStorage.setItem('mtdConsumptionData', JSON.stringify(mtdConsumptionData));
            }
            
            // Load MTD consumption data from localStorage
            function loadMTDConsumptionData() {
                const savedData = localStorage.getItem('mtdConsumptionData');
                if (!savedData) return;
                
                const mtdConsumptionData = JSON.parse(savedData);
                const rows = inventoryBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const itemName = row.querySelector('td:first-child').textContent;
                    const mtdConsumptionInput = row.querySelector('.mtd-consumption');
                    if (mtdConsumptionInput && mtdConsumptionData[itemName] !== undefined) {
                        mtdConsumptionInput.value = mtdConsumptionData[itemName];
                    }
                });
                
                // Update calculations after loading MTD data
                updateAllCalculations();
            }
            
            function updateClock() {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString();
                dateElement.textContent = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            function updateSelectedDateDisplay(month, day, year) {
                selectedDateDisplay.textContent = `Inventory for ${getMonthName(month)} ${day}, ${year}`;
            }
            
            function updateDaySelect(month, year) {
                daySelect.innerHTML = '<option value="">Select Day</option>';
                
                if (!month || !year) return;
                
                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
            }
            
            function loadInventoryForDate() {
                const year = yearSelect.value;
                const month = monthSelect.value;
                const day = daySelect.value;
                
                if (!year || !month || !day) {
                    showAlert('Please select year, month and day', 'danger');
                    return;
                }
                
                currentDate = `${year}/${month}/${day}`;
                // Save this date as the last selected date
                localStorage.setItem('lastSelectedDate', currentDate);
                updateSelectedDateDisplay(month, day, year);
                
                // Load data from localStorage
                loadInventoryData(currentDate);
            }
            
            function startNewDay() {
                const year = yearSelect.value;
                const month = monthSelect.value;
                const day = daySelect.value;
                
                if (!year || !month || !day) {
                    showAlert('Please select year, month and day', 'danger');
                    return;
                }
                
                currentDate = `${year}/${month}/${day}`;
                // Save this date as the last selected date
                localStorage.setItem('lastSelectedDate', currentDate);
                updateSelectedDateDisplay(month, day, year);
                
                // Reset system count and on hand inputs to 0
                const systemCountInputs = inventoryBody.querySelectorAll('td:nth-child(2) input');
                const onHandInputs = inventoryBody.querySelectorAll('td:nth-child(3) input');
                
                systemCountInputs.forEach(input => {
                    input.value = '0';
                    input.dispatchEvent(new Event('change'));
                });
                
                onHandInputs.forEach(input => {
                    input.value = '0';
                    input.dispatchEvent(new Event('change'));
                });
                
                showAlert('New day inventory ready', 'success');
            }
            
            function saveInventory() {
                if (!currentDate) {
                    showAlert('Please select a date first', 'danger');
                    return;
                }
                
                const inventoryData = [];
                const rows = inventoryBody.querySelectorAll('tr');
                
                currentData = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const itemName = cells[0].textContent;
                    const systemCount = cells[1].querySelector('input')?.value;
                    const onHand = cells[2].querySelector('input')?.value;
                    const variance = cells[3].textContent;
                    const mtdConsumption = cells[4].querySelector('input')?.value;
                    const avgConsumption = cells[5].textContent;
                    const consumptionPer1000 = cells[6].textContent;
                    const toOrder = cells[7].textContent;
                    const status = cells[8].querySelector('.status-badge')?.textContent;
                    
                    const itemData = {
                        itemName,
                        systemCount: parseFloat(systemCount) || 0,
                        onHand: parseFloat(onHand) || 0,
                        variance: parseFloat(variance) || 0,
                        mtdConsumption: parseFloat(mtdConsumption) || 0,
                        avgConsumption: parseFloat(avgConsumption) || 0,
                        consumptionPer1000: parseFloat(consumptionPer1000) || 0,
                        toOrder: parseFloat(toOrder) || 0,
                        status
                    };
                    inventoryData.push(itemData);
                    currentData.push(itemData);
                });
                
                // Save to localStorage with date-specific key
                localStorage.setItem(`inventory_${currentDate}`, JSON.stringify(inventoryData));
                showAlert(`Inventory saved for ${currentDate}`, 'success');
                
                // Update chart
                updateVarianceChart();
            }
            
            function exportToExcel() {
                if (!currentDate || currentData.length === 0) {
                    showAlert('No data to export', 'danger');
                    return;
                }
                
                // Prepare data for export
                const exportData = [
                    ['ITEM NAME', 'SYSTEM COUNT', 'ON HAND', 'VARIANCE', 'MTD CONSUMPTION', 
                     'AVG CONSUMPTION', 'C/1000', 'TO ORDER', 'STATUS'],
                    ...currentData.map(item => [
                        item.itemName,
                        item.systemCount,
                        item.onHand,
                        item.variance,
                        item.mtdConsumption,
                        item.avgConsumption,
                        item.consumptionPer1000,
                        item.toOrder,
                        item.status
                    ]),
                    [],
                    ['MONTH TO DATE SALES:', `SAR ${salesData.mtdSales}`],
                    ['AVERAGE DAILY SALES:', `SAR ${salesData.avgDailySales}`],
                    ['FORECAST DAYS:', salesData.forecastDays],
                    ['SALES FORECAST:', `SAR ${salesData.salesForecast}`]
                ];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
                
                // Generate file and download
                const dateStr = currentDate.replace(/\//g, '-');
                XLSX.writeFile(wb, `Inventory_${dateStr}.xlsx`);
                
                showAlert('Exported to Excel', 'success');
            }
            
            function updateVarianceChart() {
                if (!currentData || currentData.length === 0) {
                    // Clear chart if no data
                    if (varianceChart) {
                        varianceChart.destroy();
                        varianceChart = null;
                    }
                    return;
                }
                
                // Sort data by absolute variance (descending)
                const sortedData = [...currentData].sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
                
                // Get top 10 items with highest variance
                const topItems = sortedData.slice(0, 10);
                
                const ctx = varianceChartCanvas.getContext('2d');
                
                // Destroy previous chart if exists
                if (varianceChart) {
                    varianceChart.destroy();
                }
                
                varianceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topItems.map(item => item.itemName),
                        datasets: [
                            {
                                label: 'System Count',
                                data: topItems.map(item => item.systemCount),
                                backgroundColor: 'rgba(66, 153, 225, 0.7)',
                                borderColor: 'rgba(66, 153, 225, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'On Hand',
                                data: topItems.map(item => item.onHand),
                                backgroundColor: 'rgba(72, 187, 120, 0.7)',
                                borderColor: 'rgba(72, 187, 120, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Variance',
                                data: topItems.map(item => item.variance),
                                backgroundColor: 'rgba(237, 137, 54, 0.7)',
                                borderColor: 'rgba(237, 137, 54, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.7)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: 'rgba(0, 0, 0, 0.7)',
                                    maxRotation: 45
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(0, 0, 0, 0.7)'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
            }
            
            function showAlert(message, type) {
                // Remove any existing alerts
                const existingAlerts = document.querySelectorAll('.alert-custom');
                existingAlerts.forEach(alert => alert.remove());
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
                
                let icon = '';
                if (type === 'success') icon = '<i class="fas fa-check-circle me-2"></i>';
                else if (type === 'warning') icon = '<i class="fas fa-exclamation-triangle me-2"></i>';
                else if (type === 'danger') icon = '<i class="fas fa-exclamation-circle me-2"></i>';
                
                alertDiv.innerHTML = `
                    ${icon} ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.classList.remove('show');
                        setTimeout(() => alertDiv.remove(), 150);
                    }
                }, 5000);
            }
            
            function loadInventoryData(date) {
                const savedData = localStorage.getItem(`inventory_${date}`);
                
                if (savedData) {
                    const inventoryData = JSON.parse(savedData);
                    currentData = inventoryData;
                    
                    // Update the table with saved values
                    const rows = inventoryBody.querySelectorAll('tr');
                    
                    rows.forEach((row, index) => {
                        const itemData = inventoryData[index];
                        if (itemData) {
                            const cells = row.querySelectorAll('td');
                            
                            // Update input values
                            cells[1].querySelector('input').value = itemData.systemCount;
                            cells[2].querySelector('input').value = itemData.onHand;
                            
                            // Update calculated values
                            cells[3].textContent = itemData.variance.toFixed(2);
                            
                            // Set variance color
                            if (itemData.variance < 0) {
                                cells[3].className = 'variance-negative';
                            } else if (itemData.variance > 0) {
                                cells[3].className = 'variance-positive';
                            } else {
                                cells[3].className = '';
                            }
                            
                            // MTD Consumption is loaded from separate storage
                            cells[5].textContent = itemData.avgConsumption || '0';
                            cells[6].textContent = itemData.consumptionPer1000 || '0';
                            cells[7].textContent = itemData.toOrder || '0';
                            
                            // Set status
                            if (itemData.status === 'OK') {
                                cells[8].innerHTML = '<span class="status-badge status-ok">OK</span>';
                            } else if (itemData.status === 'LOW') {
                                cells[8].innerHTML = '<span class="status-badge status-warning">LOW</span>';
                            } else {
                                cells[8].innerHTML = '<span class="status-badge status-critical">ORDER</span>';
                            }
                        }
                    });
                    
                    showAlert(`Inventory loaded for ${date}`, 'success');
                    
                    // Update chart and metrics
                    updateVarianceChart();
                    updateMetrics();
                } else {
                    showAlert('No inventory data found for this date', 'warning');
                }
            }
            
            function getMonthName(monthNumber) {
                const months = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                return months[parseInt(monthNumber) - 1];
            }
            
            function setupEventListeners() {
                // Month select change updates day select
                monthSelect.addEventListener('change', function() {
                    const year = yearSelect.value;
                    const month = monthSelect.value;
                    if (year && month) {
                        updateDaySelect(month, year);
                    }
                });
                
                // Year select change updates day select if month is selected
                yearSelect.addEventListener('change', function() {
                    const year = yearSelect.value;
                    const month = monthSelect.value;
                    if (year && month) {
                        updateDaySelect(month, year);
                    }
                });
                
                // Load button
                loadBtn.addEventListener('click', loadInventoryForDate);
                
                // New Day button
                newDayBtn.addEventListener('click', startNewDay);
                
                // Save button
                saveBtn.addEventListener('click', saveInventory);
                
                // Export to Excel button
                exportBtn.addEventListener('click', exportToExcel);
                
                // Theme toggle
                themeToggle.addEventListener('click', function() {
                    const currentTheme = document.body.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    setTheme(newTheme);
                });
                
                // Close welcome modal
                closeWelcome.addEventListener('click', function() {
                    welcomeModal.style.display = 'none';
                });
            }
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>


