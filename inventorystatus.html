<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVENTORY CONTROL v4.7</title>
    <!-- Bootstrap 2025 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@2025.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --hacker-green: #00ff41;
            --matrix-dark: #0d0208;
            --terminal-text: #0aff0a;
            --dark-panel: #0a1a0a;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: var(--matrix-dark);
            color: var(--terminal-text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container-fluid {
            padding: 20px;
            max-width: 1400px;
        }
        
        .header {
            border-bottom: 1px solid var(--hacker-green);
            padding-bottom: 15px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .header::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--hacker-green), transparent);
        }
        
        h1 {
            color: var(--hacker-green);
            text-shadow: 0 0 5px var(--hacker-green);
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .panel {
            background-color: var(--dark-panel);
            border: 1px solid var(--hacker-green);
            border-radius: 0;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .panel-title {
            color: var(--hacker-green);
            border-bottom: 1px dashed var(--hacker-green);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        select, input, button {
            background-color: #111 !important;
            color: var(--terminal-text) !important;
            border: 1px solid var(--hacker-green) !important;
            border-radius: 0 !important;
        }
        
        select:focus, input:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 65, 0.25) !important;
            border-color: var(--hacker-green) !important;
        }
        
        .btn-primary {
            background-color: var(--matrix-dark) !important;
            color: var(--hacker-green) !important;
            border: 1px solid var(--hacker-green) !important;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--hacker-green) !important;
            color: var(--matrix-dark) !important;
            box-shadow: 0 0 10px var(--hacker-green);
        }
        
        .btn-danger {
            background-color: var(--matrix-dark) !important;
            color: #ff5555 !important;
            border: 1px solid #ff5555 !important;
        }
        
        .btn-danger:hover {
            background-color: #ff5555 !important;
            color: var(--matrix-dark) !important;
        }
        
        .btn-success {
            background-color: var(--matrix-dark) !important;
            color: var(--hacker-green) !important;
            border: 1px solid var(--hacker-green) !important;
        }
        
        .btn-success:hover {
            background-color: var(--hacker-green) !important;
            color: var(--matrix-dark) !important;
        }
        
        table {
            color: var(--terminal-text) !important;
            width: 100%;
        }
        
        th {
            background-color: var(--dark-panel) !important;
            color: var(--hacker-green) !important;
            border-bottom: 2px solid var(--hacker-green) !important;
            position: sticky;
            top: 0;
        }
        
        td {
            border-color: #1a3a1a !important;
            vertical-align: middle !important;
        }
        
        tr:hover {
            background-color: rgba(0, 255, 65, 0.05) !important;
        }
        
        .variance-positive {
            color: var(--hacker-green);
            font-weight: bold;
        }
        
        .variance-negative {
            color: #ff5555;
            font-weight: bold;
        }
        
        .empty-table-message {
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 5px var(--hacker-green);
            }
            to {
                text-shadow: 0 0 10px var(--hacker-green), 0 0 20px var(--hacker-green);
            }
        }
        
        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(0, 255, 65, 0.05) 0%,
                rgba(0, 0, 0, 0) 10%
            );
            background-size: 100% 8px;
            pointer-events: none;
            z-index: 1000;
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 0 100%;
            }
        }
        
        /* Sales Targets Panel */
        .sales-targets-panel {
            background-color: rgba(0, 20, 0, 0.7);
            border: 1px solid var(--hacker-green);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .sales-input-group {
            margin: 5px;
            min-width: 200px;
        }
        
        .sales-input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--hacker-green);
        }
        
        .sales-input-group input, .sales-input-group select {
            width: 100%;
            padding: 8px;
            background-color: #111;
            color: var(--terminal-text);
            border: 1px solid var(--hacker-green);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .date-selector > * {
                margin-bottom: 10px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .sales-targets-panel {
                flex-direction: column;
            }
            
            .sales-input-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div class="container-fluid">
        <div class="header">
            <div class="row">
                <div class="col-md-8">
                    <h1 class="glow">INVENTORY CONTROL v4.7</h1>
                    <p class="text-muted">SYSTEM READY | DATA ENCRYPTED | ACCESS GRANTED</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div id="clock" class="h4"></div>
                    <div id="date-display"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <h3 class="panel-title">VARIANCE ANALYTICS</h3>
                    <div class="chart-container">
                        <canvas id="varianceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <div class="row">
                        <div class="col-md-8">
                            <h3 class="panel-title">INVENTORY MANAGEMENT</h3>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <button id="export-excel" class="btn btn-success me-2">
                                <i class="bi bi-file-earmark-excel"></i> EXPORT TO EXCEL
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sales Targets Section - Removed target sales input -->
                    <div class="sales-targets-panel">
                        <div class="sales-input-group">
                            <label for="month-to-date-sales">MONTH TO DATE SALES:</label>
                            <input type="number" id="month-to-date-sales" placeholder="Enter amount">
                        </div>
                        <div class="sales-input-group">
                            <label for="average-daily-sales">AVERAGE DAILY SALES:</label>
                            <input type="number" id="average-daily-sales" placeholder="Calculated" readonly>
                        </div>
                        <div class="sales-input-group">
                            <label for="forecast-days">FORECAST DAYS (1-10):</label>
                            <select id="forecast-days" class="form-select">
                                <option value="1">1 Day</option>
                                <option value="2">2 Days</option>
                                <option value="3">3 Days</option>
                                <option value="4">4 Days</option>
                                <option value="5">5 Days</option>
                                <option value="6">6 Days</option>
                                <option value="7">7 Days</option>
                                <option value="8">8 Days</option>
                                <option value="9">9 Days</option>
                                <option value="10">10 Days</option>
                            </select>
                        </div>
                        <div class="sales-input-group">
                            <label for="sales-forecast">SALES FORECAST:</label>
                            <input type="number" id="sales-forecast" placeholder="Calculated" readonly>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select id="month-select" class="form-select">
                                <option value="">SELECT MONTH</option>
                                <option value="1">JANUARY</option>
                                <option value="2">FEBRUARY</option>
                                <option value="3">MARCH</option>
                                <option value="4">APRIL</option>
                                <option value="5">MAY</option>
                                <option value="6">JUNE</option>
                                <option value="7">JULY</option>
                                <option value="8">AUGUST</option>
                                <option value="9">SEPTEMBER</option>
                                <option value="10">OCTOBER</option>
                                <option value="11">NOVEMBER</option>
                                <option value="12">DECEMBER</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="day-select" class="form-select">
                                <option value="">SELECT DAY</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="year-select" class="form-select">
                                <option value="">SELECT YEAR</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="load-btn" class="btn btn-primary w-100">LOAD INVENTORY</button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button id="new-day-btn" class="btn btn-primary w-100">NEW DAY</button>
                        </div>
                        <div class="col-md-6">
                            <button id="save-btn" class="btn btn-success w-100">SAVE INVENTORY</button>
                        </div>
                    </div>
                    
                    <div class="selected-date h4 text-center mb-3" id="selected-date-display">
                        SELECT DATE TO BEGIN
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table" id="inventory-table">
                            <thead>
                                <tr>
                                    <th>ITEM NAME</th>
                                    <th>SYSTEM COUNT</th>
                                    <th>ON HAND</th>
                                    <th>VARIANCE</th>
                                    <th>MTD CONSUMPTION</th>
                                    <th>AVG CONSUMPTION</th>
                                    <th>C/1000</th>
                                    <th>TO ORDER</th>
                                    <th>REPLENISH</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-body">
                                <!-- Items will be loaded here automatically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 2025 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@2025.0.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Static item list - all items always displayed
            const staticItems = [
                "Philly Beef",
                "Beef Steak",
                "Chicken Steak",
                "Lunch Chicken",
                "Grill Chicken",
                "Spicy Chicken",
                "12 inch Tortilla",
                "10.5 inch Tortilla",
                "8 inch Tortilla",
                "Chicken Burger",
                "Junior Burger",
                "Nuggets",
                "Regular Bytes",
                "Spicy Bytes",
                "Veggie",
                "Quatro",
                "Aldella Strips",
                "Hotdog",
                "Eggs",
                "Pancake Powder",
                "Fries",
                "Crispy",
                "Hushbrown",
                "Vanilla Muffin",
                "Choco Muffin",
                "Sansbastian Cake",
                "Brownese Cheese Cake",
                "Steak Bread",
                "Brown Bread",
                "Big Bun",
                "Small Bun",
                "Kiddie Bread",
                "4.0 Potato Bun",
                "Potato Steak Bread",
                "White Bread",
                "Multigrain Bread"
            ];

            // DOM elements
            const monthSelect = document.getElementById('month-select');
            const daySelect = document.getElementById('day-select');
            const yearSelect = document.getElementById('year-select');
            const loadBtn = document.getElementById('load-btn');
            const newDayBtn = document.getElementById('new-day-btn');
            const saveBtn = document.getElementById('save-btn');
            const exportBtn = document.getElementById('export-excel');
            const selectedDateDisplay = document.getElementById('selected-date-display');
            const inventoryBody = document.getElementById('inventory-body');
            const clockElement = document.getElementById('clock');
            const dateElement = document.getElementById('date-display');
            const varianceChartCanvas = document.getElementById('varianceChart');
            const mtdSalesInput = document.getElementById('month-to-date-sales');
            const avgDailySalesInput = document.getElementById('average-daily-sales');
            const forecastDaysSelect = document.getElementById('forecast-days');
            const salesForecastInput = document.getElementById('sales-forecast');
            
            // Chart variables
            let varianceChart = null;
            
            // Current selected date
            let currentDate = null;
            let currentData = [];
            let salesData = {
                mtdSales: 0,
                avgDailySales: 0,
                forecastDays: 1,
                salesForecast: 0
            };
            
            // Initialize the app
            function init() {
                updateClock();
                setInterval(updateClock, 1000);
                
                // Populate years (current year -1 to +2)
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 1; i <= currentYear + 2; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                yearSelect.value = currentYear;
                
                // Create all inventory items on page load
                createInventoryItems();
                
                // Check if there's a previously selected date in localStorage
                const lastDate = localStorage.getItem('lastSelectedDate');
                if (lastDate) {
                    const [year, month, day] = lastDate.split('/');
                    yearSelect.value = year;
                    monthSelect.value = month;
                    updateDaySelect(parseInt(month), parseInt(year));
                    daySelect.value = day;
                    currentDate = lastDate;
                    loadInventoryData(currentDate);
                    updateSelectedDateDisplay(month, day, year);
                }
                
                // Load sales data if exists
                const savedSalesData = localStorage.getItem('salesData');
                if (savedSalesData) {
                    salesData = JSON.parse(savedSalesData);
                    mtdSalesInput.value = salesData.mtdSales;
                    avgDailySalesInput.value = salesData.avgDailySales;
                    forecastDaysSelect.value = salesData.forecastDays;
                    salesForecastInput.value = salesData.salesForecast;
                }
                
                // Load MTD consumption data if exists
                loadMTDConsumptionData();
                
                // Set up event listeners
                setupEventListeners();
            }
            
            // Create all inventory items in the table
            function createInventoryItems() {
                inventoryBody.innerHTML = '';
                
                staticItems.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Item Name (fixed)
                    const itemNameCell = document.createElement('td');
                    itemNameCell.textContent = item;
                    row.appendChild(itemNameCell);
                    
                    // System Count (previously Open Stock)
                    const systemCountCell = document.createElement('td');
                    const systemCountInput = document.createElement('input');
                    systemCountInput.type = 'number';
                    systemCountInput.className = 'form-control';
                    systemCountInput.value = '0';
                    systemCountInput.step = '0.01';
                    systemCountInput.min = '0';
                    systemCountCell.appendChild(systemCountInput);
                    row.appendChild(systemCountCell);
                    
                    // On Hand (previously System Count)
                    const onHandCell = document.createElement('td');
                    const onHandInput = document.createElement('input');
                    onHandInput.type = 'number';
                    onHandInput.className = 'form-control';
                    onHandInput.value = '0';
                    onHandInput.step = '0.01';
                    onHandInput.min = '0';
                    onHandCell.appendChild(onHandInput);
                    row.appendChild(onHandCell);
                    
                    // Variance (calculated: On Hand - System Count)
                    const varianceCell = document.createElement('td');
                    varianceCell.textContent = '0';
                    row.appendChild(varianceCell);
                    
                    // MTD Consumption (user input, persists across dates)
                    const mtdConsumptionCell = document.createElement('td');
                    const mtdConsumptionInput = document.createElement('input');
                    mtdConsumptionInput.type = 'number';
                    mtdConsumptionInput.className = 'form-control mtd-consumption';
                    mtdConsumptionInput.value = '0';
                    mtdConsumptionInput.step = '0.01';
                    mtdConsumptionInput.min = '0';
                    mtdConsumptionCell.appendChild(mtdConsumptionInput);
                    row.appendChild(mtdConsumptionCell);
                    
                    // Average Consumption (calculated: MTD Consumption / current day of month)
                    const avgConsumptionCell = document.createElement('td');
                    avgConsumptionCell.textContent = '0';
                    row.appendChild(avgConsumptionCell);
                    
                    // Consumption per 1000 (calculated: avgConsumption / avgDailySales * 1000)
                    const consumptionPer1000Cell = document.createElement('td');
                    consumptionPer1000Cell.textContent = '0';
                    row.appendChild(consumptionPer1000Cell);
                    
                    // To Order (calculated: consumptionPer1000 * (salesForecast / 1000))
                    const toOrderCell = document.createElement('td');
                    toOrderCell.textContent = '0';
                    row.appendChild(toOrderCell);
                    
                    // Replenish (calculated: checks to order vs system count)
                    const replenishCell = document.createElement('td');
                    replenishCell.textContent = '0';
                    row.appendChild(replenishCell);
                    
                    // Add event listeners for calculation
                    const calculateValues = function() {
                        const systemCount = parseFloat(systemCountInput.value) || 0;
                        const onHand = parseFloat(onHandInput.value) || 0;
                        
                        // Calculate variance (On Hand - System Count)
                        const variance = onHand - systemCount;
                        varianceCell.textContent = variance.toFixed(2);
                        
                        // Update variance color based on the value
                        if (variance < 0) {
                            // Negative variance (on hand < system count) - show in red
                            varianceCell.className = 'variance-negative';
                        } else if (variance > 0) {
                            // Positive variance (on hand > system count) - show in green
                            varianceCell.className = 'variance-positive';
                        } else {
                            // Zero variance - no special styling
                            varianceCell.className = '';
                        }
                        
                        // Get current date for calculations
                        const today = new Date();
                        const currentDay = today.getDate();
                        
                        // Get MTD consumption
                        const mtdConsumption = parseFloat(mtdConsumptionInput.value) || 0;
                        
                        // Calculate average consumption (MTD / current day of month)
                        const avgConsumption = mtdConsumption / currentDay;
                        avgConsumptionCell.textContent = avgConsumption.toFixed(2);
                        
                        // Calculate consumption per 1000 (avgConsumption / avgDailySales * 1000)
                        const avgDailySales = parseFloat(avgDailySalesInput.value) || 1; // avoid division by zero
                        const consumptionPer1000 = (avgConsumption / avgDailySales) * 1000;
                        consumptionPer1000Cell.textContent = consumptionPer1000.toFixed(2);
                        
                        // Calculate to order (consumptionPer1000 * (salesForecast / 1000))
                        const salesForecast = parseFloat(salesForecastInput.value) || 0;
                        const toOrder = consumptionPer1000 * (salesForecast / 1000);
                        toOrderCell.textContent = toOrder.toFixed(2);
                        
                        // Calculate replenish (check to order vs system count)
                        const replenish = toOrder - systemCount;
                        if (replenish <= 0) {
                            replenishCell.textContent = 'OK';
                            replenishCell.className = 'variance-positive';
                        } else {
                            replenishCell.textContent = replenish.toFixed(2);
                            replenishCell.className = 'variance-negative';
                        }
                    };
                    
                    // Add event listeners to inputs that trigger calculations
                    systemCountInput.addEventListener('change', calculateValues);
                    onHandInput.addEventListener('change', calculateValues);
                    mtdConsumptionInput.addEventListener('change', function() {
                        calculateValues();
                        saveMTDConsumptionData(); // Save MTD consumption when changed
                    });
                    
                    // Add row to the table
                    inventoryBody.appendChild(row);
                });
                
                // Add event listeners to sales inputs that affect calculations
                mtdSalesInput.addEventListener('input', function() {
                    calculateSalesMetrics();
                    updateAllCalculations();
                });
                forecastDaysSelect.addEventListener('change', function() {
                    calculateSalesMetrics();
                    updateAllCalculations();
                });
            }
            
            // Calculate sales metrics (MTD, forecast, etc.)
            function calculateSalesMetrics() {
                // Get current values
                const mtdSales = parseFloat(mtdSalesInput.value) || 0;
                const forecastDays = parseInt(forecastDaysSelect.value) || 1;
                
                // Get current date
                const today = new Date();
                const currentDay = today.getDate();
                
                // Calculate average daily sales (MTD Sales / current day of month)
                const avgDailySales = mtdSales / currentDay;
                
                // Calculate sales forecast (average daily sales * forecast days)
                const salesForecast = avgDailySales * forecastDays;
                
                // Update the UI
                avgDailySalesInput.value = avgDailySales.toFixed(2);
                salesForecastInput.value = salesForecast.toFixed(2);
                
                // Save to salesData object
                salesData = {
                    mtdSales,
                    avgDailySales,
                    forecastDays,
                    salesForecast
                };
                
                // Save to localStorage
                localStorage.setItem('salesData', JSON.stringify(salesData));
            }
            
            // Update all calculations in the table (when sales data changes)
            function updateAllCalculations() {
                const rows = inventoryBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const systemCountInput = row.querySelector('td:nth-child(2) input');
                    const onHandInput = row.querySelector('td:nth-child(3) input');
                    const mtdConsumptionInput = row.querySelector('td:nth-child(5) input');
                    
                    // Trigger calculation for each row
                    if (systemCountInput && onHandInput && mtdConsumptionInput) {
                        systemCountInput.dispatchEvent(new Event('change'));
                        onHandInput.dispatchEvent(new Event('change'));
                        mtdConsumptionInput.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Save MTD consumption data to localStorage
            function saveMTDConsumptionData() {
                const mtdConsumptionData = {};
                const rows = inventoryBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const itemName = row.querySelector('td:first-child').textContent;
                    const mtdConsumptionInput = row.querySelector('.mtd-consumption');
                    if (mtdConsumptionInput) {
                        mtdConsumptionData[itemName] = parseFloat(mtdConsumptionInput.value) || 0;
                    }
                });
                
                localStorage.setItem('mtdConsumptionData', JSON.stringify(mtdConsumptionData));
            }
            
            // Load MTD consumption data from localStorage
            function loadMTDConsumptionData() {
                const savedData = localStorage.getItem('mtdConsumptionData');
                if (!savedData) return;
                
                const mtdConsumptionData = JSON.parse(savedData);
                const rows = inventoryBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const itemName = row.querySelector('td:first-child').textContent;
                    const mtdConsumptionInput = row.querySelector('.mtd-consumption');
                    if (mtdConsumptionInput && mtdConsumptionData[itemName] !== undefined) {
                        mtdConsumptionInput.value = mtdConsumptionData[itemName];
                    }
                });
                
                // Update calculations after loading MTD data
                updateAllCalculations();
            }
            
            function updateClock() {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString();
                dateElement.textContent = now.toLocaleDateString();
            }
            
            function updateSelectedDateDisplay(month, day, year) {
                selectedDateDisplay.textContent = `INVENTORY FOR ${getMonthName(month)} ${day}, ${year}`;
                selectedDateDisplay.className = 'h4 text-center mb-3 glow';
                setTimeout(() => {
                    selectedDateDisplay.classList.remove('glow');
                }, 2000);
            }
            
            function updateDaySelect(month, year) {
                daySelect.innerHTML = '<option value="">SELECT DAY</option>';
                
                if (!month || !year) return;
                
                const daysInMonth = new Date(year, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
            }
            
            function loadInventoryForDate() {
                const year = yearSelect.value;
                const month = monthSelect.value;
                const day = daySelect.value;
                
                if (!year || !month || !day) {
                    showAlert('PLEASE SELECT YEAR, MONTH AND DAY', 'danger');
                    return;
                }
                
                currentDate = `${year}/${month}/${day}`;
                // Save this date as the last selected date
                localStorage.setItem('lastSelectedDate', currentDate);
                updateSelectedDateDisplay(month, day, year);
                
                // Load data from localStorage
                loadInventoryData(currentDate);
            }
            
            function startNewDay() {
                const year = yearSelect.value;
                const month = monthSelect.value;
                const day = daySelect.value;
                
                if (!year || !month || !day) {
                    showAlert('PLEASE SELECT YEAR, MONTH AND DAY', 'danger');
                    return;
                }
                
                currentDate = `${year}/${month}/${day}`;
                // Save this date as the last selected date
                localStorage.setItem('lastSelectedDate', currentDate);
                updateSelectedDateDisplay(month, day, year);
                
                // Reset system count and on hand inputs to 0
                const systemCountInputs = inventoryBody.querySelectorAll('td:nth-child(2) input');
                const onHandInputs = inventoryBody.querySelectorAll('td:nth-child(3) input');
                
                systemCountInputs.forEach(input => {
                    input.value = '0';
                    input.dispatchEvent(new Event('change'));
                });
                
                onHandInputs.forEach(input => {
                    input.value = '0';
                    input.dispatchEvent(new Event('change'));
                });
                
                showAlert('NEW DAY INVENTORY READY', 'success');
            }
            
            function saveInventory() {
                if (!currentDate) {
                    showAlert('PLEASE SELECT A DATE FIRST', 'danger');
                    return;
                }
                
                const inventoryData = [];
                const rows = inventoryBody.querySelectorAll('tr');
                
                currentData = [];
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const itemName = cells[0].textContent;
                    const systemCount = cells[1].querySelector('input')?.value;
                    const onHand = cells[2].querySelector('input')?.value;
                    const variance = cells[3].textContent;
                    const mtdConsumption = cells[4].querySelector('input')?.value;
                    const avgConsumption = cells[5].textContent;
                    const consumptionPer1000 = cells[6].textContent;
                    const toOrder = cells[7].textContent;
                    const replenish = cells[8].textContent;
                    
                    const itemData = {
                        itemName,
                        systemCount: parseFloat(systemCount) || 0,
                        onHand: parseFloat(onHand) || 0,
                        variance: parseFloat(variance) || 0,
                        mtdConsumption: parseFloat(mtdConsumption) || 0,
                        avgConsumption: parseFloat(avgConsumption) || 0,
                        consumptionPer1000: parseFloat(consumptionPer1000) || 0,
                        toOrder: parseFloat(toOrder) || 0,
                        replenish
                    };
                    inventoryData.push(itemData);
                    currentData.push(itemData);
                });
                
                // Save to localStorage with date-specific key
                localStorage.setItem(`inventory_${currentDate}`, JSON.stringify(inventoryData));
                showAlert(`INVENTORY SAVED FOR ${currentDate}`, 'success');
                
                // Update chart
                updateVarianceChart();
            }
            
            function exportToExcel() {
                if (!currentDate || currentData.length === 0) {
                    showAlert('NO DATA TO EXPORT', 'danger');
                    return;
                }
                
                // Prepare data for export
                const exportData = [
                    ['ITEM NAME', 'SYSTEM COUNT', 'ON HAND', 'VARIANCE', 'MTD CONSUMPTION', 
                     'AVG CONSUMPTION', 'C/1000', 'TO ORDER', 'REPLENISH'],
                    ...currentData.map(item => [
                        item.itemName,
                        item.systemCount,
                        item.onHand,
                        item.variance,
                        item.mtdConsumption,
                        item.avgConsumption,
                        item.consumptionPer1000,
                        item.toOrder,
                        item.replenish
                    ]),
                    [],
                    ['MONTH TO DATE SALES:', salesData.mtdSales],
                    ['AVERAGE DAILY SALES:', salesData.avgDailySales],
                    ['FORECAST DAYS:', salesData.forecastDays],
                    ['SALES FORECAST:', salesData.salesForecast]
                ];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
                
                // Generate file and download
                const dateStr = currentDate.replace(/\//g, '-');
                XLSX.writeFile(wb, `Inventory_${dateStr}.xlsx`);
                
                showAlert('EXPORTED TO EXCEL', 'success');
            }
            
            function updateVarianceChart() {
                if (!currentData || currentData.length === 0) {
                    // Clear chart if no data
                    if (varianceChart) {
                        varianceChart.destroy();
                        varianceChart = null;
                    }
                    return;
                }
                
                // Sort data by absolute variance (descending)
                const sortedData = [...currentData].sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
                
                // Get top 10 items with highest variance
                const topItems = sortedData.slice(0, 10);
                
                const ctx = varianceChartCanvas.getContext('2d');
                
                // Destroy previous chart if exists
                if (varianceChart) {
                    varianceChart.destroy();
                }
                
                varianceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topItems.map(item => item.itemName),
                        datasets: [
                            {
                                label: 'System Count',
                                data: topItems.map(item => item.systemCount),
                                backgroundColor: 'rgba(0, 255, 65, 0.7)',
                                borderColor: 'rgba(0, 255, 65, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'On Hand',
                                data: topItems.map(item => item.onHand),
                                backgroundColor: 'rgba(0, 150, 255, 0.7)',
                                borderColor: 'rgba(0, 150, 255, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Variance',
                                data: topItems.map(item => item.variance),
                                backgroundColor: 'rgba(255, 150, 0, 0.7)',
                                borderColor: 'rgba(255, 150, 0, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 255, 65, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(0, 255, 65, 0.8)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 255, 65, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(0, 255, 65, 0.8)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(0, 255, 65, 0.8)'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        animation: {
                            duration: 2000
                        }
                    }
                });
            }
            
            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
                alertDiv.style.zIndex = '2000';
                alertDiv.style.minWidth = '300px';
                alertDiv.textContent = message;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.classList.add('fade');
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 500);
                }, 3000);
            }
            
            function loadInventoryData(date) {
                const savedData = localStorage.getItem(`inventory_${date}`);
                
                if (savedData) {
                    const inventoryData = JSON.parse(savedData);
                    currentData = inventoryData;
                    
                    // Update the table with saved values
                    const rows = inventoryBody.querySelectorAll('tr');
                    
                    rows.forEach((row, index) => {
                        const itemData = inventoryData[index];
                        if (itemData) {
                            const cells = row.querySelectorAll('td');
                            
                            // Update input values
                            cells[1].querySelector('input').value = itemData.systemCount;
                            cells[2].querySelector('input').value = itemData.onHand;
                            
                            // Update calculated values
                            cells[3].textContent = itemData.variance.toFixed(2);
                            
                            // Set variance color
                            if (itemData.variance < 0) {
                                cells[3].className = 'variance-negative';
                            } else if (itemData.variance > 0) {
                                cells[3].className = 'variance-positive';
                            } else {
                                cells[3].className = '';
                            }
                            
                            // MTD Consumption is loaded from separate storage
                            cells[5].textContent = itemData.avgConsumption || '0';
                            cells[6].textContent = itemData.consumptionPer1000 || '0';
                            cells[7].textContent = itemData.toOrder || '0';
                            cells[8].textContent = itemData.replenish || '0';
                        }
                    });
                    
                    showAlert(`INVENTORY LOADED FOR ${date}`, 'success');
                    
                    // Update chart
                    updateVarianceChart();
                } else {
                    showAlert('NO INVENTORY DATA FOUND FOR THIS DATE', 'warning');
                }
            }
            
            function getMonthName(monthNumber) {
                const months = [
                    'JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                    'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'
                ];
                return months[parseInt(monthNumber) - 1];
            }
            
            function setupEventListeners() {
                // Month select change updates day select
                monthSelect.addEventListener('change', function() {
                    const year = yearSelect.value;
                    const month = monthSelect.value;
                    if (year && month) {
                        updateDaySelect(month, year);
                    }
                });
                
                // Year select change updates day select if month is selected
                yearSelect.addEventListener('change', function() {
                    const year = yearSelect.value;
                    const month = monthSelect.value;
                    if (year && month) {
                        updateDaySelect(month, year);
                    }
                });
                
                // Load button
                loadBtn.addEventListener('click', loadInventoryForDate);
                
                // New Day button
                newDayBtn.addEventListener('click', startNewDay);
                
                // Save button
                saveBtn.addEventListener('click', saveInventory);
                
                // Export to Excel button
                exportBtn.addEventListener('click', exportToExcel);
            }
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>
